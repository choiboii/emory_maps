<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
    crossorigin="anonymous">
    <script src = "https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <style>
        #map {
            flex-basis: 0;
            flex-grow: 4;
            height: 600px;
        }

        .container {
            width: 40%;
            float: left;
            margin-left: 1%;
        }

        #floating-panel {
            position: absolute;
            top: 75px;
            left: 175px;
            z-index: 5;
            text-align: center;
            font-family: "Roboto", "sans-serif";
            line-height: 30px;
            padding-left: 10px;
        }

        .google_map iframe{
            width:100%;
        }

        clearfix {
            clear: both
        }

        #location-form {
            margin-left: 2.5%;
            width: 95%;
            padding-top: 8px;
        }

        #clear {
            color: gray;
            border-left: none;
            border-color: lightgray;
        }

        #directions-panel {
            position: absolute;
            top: 50px;
            left: 2.5%;
            z-index: 5;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #999;
            text-align: center;
            font-family: "Roboto", "sans-serif";
            line-height: 30px;
            padding-left: 10px;
            float: left;
        }
        #container {
            height: 600px;
            display: flex;
        }

        #sidebar {
            flex-basis: 15rem;
            flex-grow: 1;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            max-width: 30rem;
            height: 600px;
            box-sizing: border-box;
            overflow: auto;
        }

        #directions-sidebar {
            flex-basis: 15rem;
            flex-grow: 1;
            padding: 1rem;
            max-width: 30rem;
            height: 100%;
            box-sizing: border-box;
            overflow: auto;
        }

        #place-photos {
            max-width: auto;
            max-height: 225px;
            object-fit: cover;
        }

        .button-group {
            padding-bottom: 50px;
        }

        .btn-group .scroll-btn {
            color: white;
            border: none;
            padding: 8px;
            text-align: center;
            display: inline-block;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
        }
        /* Dropdown Button */

        .btn {
            background-color: #c8c2c2;
            padding: 8px;
            font-size: 12px;
            border: none;
            cursor: pointer;
        }

        .btn:hover, .btn:focus {
            background-color: #6f6f6f;
        }

        /* Dropdown button on hover & focus */
        .dropbtn:hover, .dropbtn:focus {
            background-color: #6f6f6f;
        }

        .dropdown:hover .dropdown-content {display: block;}

        /* The container <div> - needed to position the dropdown content */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        /* Dropdown Content (Hidden by Default) */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f1f1f1;
            min-width: 120px;
            box-shadow: 0px 8px 8px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }

        /* Links inside the dropdown */
        .dropdown-content a {
            color: black;
            padding: 1px 1px;
            text-decoration: none;
            display: block;
            font-size: 12px;
        }

        /* Change color of dropdown links on hover */
        .dropdown-content a:hover {background-color: #ddd;}

        /* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
        .show {display:block;}

        @media only screen and (max-width: 1025px) {
            #floating-panel {
                display: none;
            }
        }   
    </style> 
</head>
<body>
    <div id = 'location-form' class="input-group mb-3">
        <input id = 'location-input' type="text" class="form-control" placeholder="Search for a place" aria-label="Recipient's username" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <button id='clear' class="btn btn-outline-secondary" type="button">X</button>
        </div>
    </div>
    <div id="container">
    <div class = 'google_map' id="map"></div>
    <div id = 'sidebar'>
        <img id = "place-photos" src="" width = 100%>
        <div class="btn-group">
            <button class="scroll-btn" id = 'left-img' type = "submit" class = "btn btn-primary btn-block" style="border-color: #212C65; background-color: #212C65;">Previous Image</button>
            <button class="scroll-btn" id = 'right-img' type = "submit" class = "btn btn-primary btn-block" style="border-color: #212C65; background-color: #212C65;">Next Image</button>
        </div>
        <div class = "card-block" id = "place-name"></div>
        <button id = 'directions-button' type = "submit" class = "btn btn-primary btn-block" style="border-color: #212C65; background-color: #212C65;">Get directions</button>
    </div>
    <div id = 'directions-sidebar'>
        <div class="dropdown">
            <button onclick = "myFunction()" class="dropbtn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Transportation
            </button>
            <div id = 'transport-drop' class="dropdown-content btn" aria-labelledby="dropdownMenuButton">
              <a class="dropdown-item" id = 'WALKING' href="#" onclick = "setTransport('WALKING')">Walking</a>
              <a class="dropdown-item" id = 'DRIVING' href="#" onclick = "setTransport('DRIVING')">Driving</a>
              <a class="dropdown-item" id = 'BICYCLING' href="#" onclick = "setTransport('BICYCLING')">Biking</a>
              <a class="dropdown-item" id = 'TRANSIT' href="#" onclick = "setTransport('TRANSIT')">Transit</a>
            </div>
          </div>
    </div>
    </div>
    <div id="floating-panel">
        <div class="dropdown">
            <button class="dropbtn btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Markers
            </button>
            <div id = 'markers-filter' class="dropdown-content" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" id = 'hide-markers' href="#">Hide</a>
                <a class="dropdown-item" id = 'show-markers' href="#">Show</a>
                <a class="dropdown-item" id = 'delete-markers' href="#">Delete</a>
            </div>
        </div>
        <div class="dropdown">
            <button class="dropbtn btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Food
            </button>
            <div id = 'food-filter' class="dropdown-content" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" id = 'food-drop' href="#">All Filters</a>
                <a class="dropdown-item" id = 'coffee-drop' href="#">Coffee</a>
                <a class="dropdown-item" id = 'dooley-drop' href="#">Dooley</a>
                <a class="dropdown-item" id = 'meal-swipes-drop' href="#">Meal Swipes</a>
                <a class="dropdown-item" id = 'vegan-drop' href="#">Vegan</a>
                <a class="dropdown-item" id = 'vegetarian-drop' href="#">Vegetarian</a>
                <a class="dropdown-item" id = 'vending-drop' href="#">Vending Machine</a>
            </div>
        </div>
        <div class="dropdown">
            <button class="dropbtn btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Study
            </button>
            <div id = 'study-filter' class="dropdown-content" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" id = 'study-drop' href="#">All Filters</a>
                <a class="dropdown-item" id = 'library-drop' href="#">Library</a>
                <a class="dropdown-item" id = 'printer-drop' href="#">Printer</a>
                <a class="dropdown-item" id = 'private-study-drop' href="#">Private Study Room</a>
                <a class="dropdown-item" id = 'whiteboard-drop' href="#">Whiteboard</a>
            </div>
        </div>
        <div class="dropdown">
            <button class="dropbtn btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Buildings
            </button>
            <div id = 'buildings-filter' class="dropdown-content" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" id = 'building-drop' href="#">All Filters</a>
                <a class="dropdown-item" id = 'academic-filter' href="#">Academic</a>
                <a class="dropdown-item" id = 'id-filter' href="#">ID Required</a>
                <a class="dropdown-item" id = 'residential-filter' href="#">Residential</a>
            </div>
        </div>
        <button  id="events-filter" class="btn" type="button" aria-haspopup="true" aria-expanded="false">Events</button>
        <button  id="current-location-button" class="btn" type="button" style = 'color:black; background-color: red;' aria-haspopup="true" aria-expanded="false">Current Location</button>
    </div>
        <iframe src="" frameborder="0"></iframe>
    </div>
    <div class="clearfix"></div>
    <script>
        async function getData(url='https://emory-maps-backend.herokuapp.com/'){
            const response = await fetch(url);
            const data = response.json();
            
            return data;
        }
        
        var map;
        var markers = [];
        var directionsRenderer;
        var directionsService;
        var stepDisplay;
        var markerArray = [];
        var x = getData();
        
        var filterPlaces = x;
        console.log(filterPlaces);
        var filterHub = [];
        var practiceRoute = [];
        var directionsStart;
        var directionsEnd;
        var currentGeometry;
        var distances = [];
        var place;
        var photoNum;
        var elevationGains = [];
        var elevations = [];

        function addMarker(props, iconLink) {
            var marker = new google.maps.Marker({
                position: props.coords,
                map: map,
                icon: iconLink
            });
    
            //check content
            if(props.content) {
                var infoWindow = new google.maps.InfoWindow({
                    content: props.content,
                });

                marker.addListener('click', function() {
                    infoWindow.open(map, marker);
                });
            }

            markers.push(marker);
        }

        function initialize() {
            initMap();
            initAutocomplete();
        }

        function initMap() {
            //map options
            var options = {
                zoom: 16,
                center:{lat: 33.7971, lng: -84.3222}
            }
            //new map
            map = new google.maps.Map(document.getElementById('map'), options);

            //listen for click on map
            google.maps.event.addListener(map, 'click', 
                function(event) {
                    addMarker({coords:event.latLng}, 'https://maps.google.com/mapfiles/ms/micons/red-dot.png');
            });

            /*filterPlaces = [
            {
              name: 'Atwood Chemistry Center',
              types: ['food', 'building', 'academic', 'study', 'coffee'],
              coords: {lat: 33.79169445277475,lng: -84.32627981186319},
              hours: `Mon-Fri 8:00 a.m. - 3:00 p.m.`
            },

            {
              name: 'Cox Hall',
              types: ['food', 'vending', 'dooley', 'printer', 'study'],
              coords: {lat: 33.79204205870855, lng: -84.32346306752329},
              hours: `Mon-Fri 7:30 a.m. - 9:00 p.m.<br> Sat-Sun 11:00 a.m. - 6:00 p.m.`,
              link: 'https://emoryatlanta.cafebonappetit.com/cafe/cox/'
            },

            {
              name: 'Woodruff Residential Center',
              types: ['building', 'dorm', 'id', 'food', 'dooley', 'meal swipes', 'vending'],
              coords: {lat: 33.7971, lng:-84.3215},
              hours: `Sun-Th 6:00 p.m. - 1:00 a.m.`,
              link: 'https://www.raysnewyorkpizza.com/copy-of-emory-university'
            }
        ];*/
        

        filterHub = [
            {
              name: 'Wonderful Wednesday',
              place: 'Asbury Circle',
              types: ['Wonderful Wednesday'],
              coords: {lat: 33.7926, lng: -84.3240},
              hours: `12:00 p.m. - 2:00 p.m.`,
              link: 'https://emory.campuslabs.com/engage/event/8149634'
            },

            {
              name: 'Giving Gratitude',
              place: 'Cox Bridge',
              types: ['TableTalk'],
              coords: {lat: 33.7924, lng: -84.3232},
              hours: `4:00 p.m. - 6:00 p.m.`,
              link: 'https://emory.campuslabs.com/engage/event/8567644'
            },

            {
              name: 'EOSA Thanksgiving Potluck',
              place: 'ESC MPR 5&6',
              types: ['Emory Orchestral Study Associate'],
              coords: {lat: 33.7935, lng: -84.3239},
              hours: `7:00 p.m. - 10:00 p.m.`,
              link: 'https://emory.campuslabs.com/engage/event/8574357'
            }
        ];

        practiceRoute = [
            {
                name: 'Woodruff Physical Education Center',
                coords: [
                    {
                        lat: 33.79347720574329,
                        lng: -84.32667216271575
                    },
                    {
                        lat: 33.793283,
                        lng: -84.325106
                    }
                ]
            },
            {
                name: 'Callaway Memorial Center',
                coords: [
                    {
                        lat: 33.79115871434023,
                        lng: -84.32413239696604
                    },
                    {
                        lat: 33.79143900561269,
                        lng: -84.32394857183496
                    },
                    {
                        lat: 33.79175782290775,
                        lng: -84.32434165763024
                    },
                    {
                        lat: 33.79134987566006,
                        lng: -84.32436966533899
                    },
                    {
                        lat: 33.791668,
                        lng: -84.324293
                    }
                ]
            }
        ];
             // add event listeners for the buttons
            document.getElementById("show-markers").addEventListener("click", function() {showMarkers(markers);});
            document.getElementById("hide-markers").addEventListener("click", function() {hideMarkers(markers);});
            document.getElementById("delete-markers").addEventListener("click", function () {deleteMarkers(markers);});
            
            document.getElementById('food-drop').addEventListener('click', function() {applyFilter('food');});
            document.getElementById('coffee-drop').addEventListener('click', function() {applyFilter('coffee');});
            document.getElementById('dooley-drop').addEventListener('click', function() {applyFilter('dooley');});
            document.getElementById('meal-swipes-drop').addEventListener('click', function() {applyFilter('meal-swipes');});
            document.getElementById('vegan-drop').addEventListener('click', function() {applyFilter('vegan');});
            document.getElementById('vegetarian-drop').addEventListener('click', function() {applyFilter('vegetarian');});

            document.getElementById('study-drop').addEventListener('click', function() {applyFilter('study');});
            document.getElementById('library-drop').addEventListener('click', function() {applyFilter('library');});
            document.getElementById('printer-drop').addEventListener('click', function() {applyFilter('printer');});
            document.getElementById('private-study-drop').addEventListener('click', function() {applyFilter('private-study');});
            document.getElementById('whiteboard-drop').addEventListener('click', function() {applyFilter('whiteboard');});

            document.getElementById('building-drop').addEventListener('click', function() {applyFilter('building');});
            document.getElementById('academic-filter').addEventListener('click', function() {applyFilter('academic');});
            document.getElementById('id-filter').addEventListener('click', function() {applyFilter('id');});
            document.getElementById('residential-filter').addEventListener('click', function() {applyFilter('dorm');});

            document.getElementById('events-filter').addEventListener('click', function() {applyEventsFilter();});

            document.getElementById('sidebar').hidden = true;
            document.getElementById('directions-button').hidden = true;
            document.getElementById('directions-sidebar').hidden = true;

            document.getElementById('right-img').addEventListener('click', function() {nextImage(place, 'right-img');});
            document.getElementById('left-img').addEventListener('click', function() {nextImage(place, 'left-img');});

            document.getElementById('current-location-button').addEventListener('click', function() {
            // Try HTML5 geolocation.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                (position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                map.setCenter(pos);
                map.setZoom(16);
                var currentPosMarker = {
                    coords:pos,
                    content: `<strong>Current Location</strong>: (${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)})`,
                }

                addMarker(currentPosMarker, 'https://maps.google.com/mapfiles/ms/micons/red-dot.png');
            },
            () => {
                handleLocationError(true, infoWindow, map.getCenter());
            });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }
            });
     
            infoWindow = new google.maps.InfoWindow();

            directionsService = new google.maps.DirectionsService();
            var rendererOptions = {
                map: map
            }
            directionsRenderer = new google.maps.DirectionsRenderer(rendererOptions);
            directionsRenderer.setPanel(document.getElementById("directions-sidebar"));

            stepDisplay = new google.maps.InfoWindow();
            
            var mode = 'WALKING';
            
            calculateAndDisplayRoute(
                directionsRenderer,
                directionsService,
                markerArray,
                stepDisplay,
                map,
                mode
            );
            /*

            function onChangeHandler() {
                calculateAndDisplayRoute(
                    directionsRenderer,
                    directionsService,
                    markerArray,
                    stepDisplay,
                    map
                );
            };

            (start).addEventListener(
                "change",
                onChangeHandler
            );
            (document.getElementById("end")).addEventListener(
                "change",
                onChangeHandler
            );
            */
        }

        var locationForm = document.getElementById('location-form');
        var clearButton = document.getElementById('clear');

        function clearDirections() {
            //document.getElementById('location-input').value='';
            document.getElementById('sidebar').hidden = true;
            document.getElementById('directions-button').hidden = true;
            document.getElementById('directions-sidebar').hidden = true;
            deleteMarkers(markers);
            deleteMarkers(markerArray);
            directionsRenderer.setMap(null);
            directionsRenderer.setPanel(null);
        }

        //event listeners
        locationForm.addEventListener('submit', geocode);
        locationForm.addEventListener('keydown', initAutocomplete);
        clearButton.addEventListener('click', function() {clearDirections(); document.getElementById('location-input').value='';});

        function myFunction() {
            document.getElementById("transport-drop").classList.toggle("show");
        }

        // Close the dropdown menu if the user clicks outside of it
        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                var i;
                for (i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function geocode(e) {
            //prevent actual submit
            e.preventDefault();

            var location = document.getElementById('location-input').value;
            
            axios.get("https://maps.googleapis.com/maps/api/geocode/json", {
                params: {
                    address: location,
                    key: "AIzaSyCsklehWRTLY54gug20dY1zByw0JosG-So"
                }
            })
            .then(function(response) {
                //log full response
                //add marker
                //addMarker(location.coords);

                //formatted address
                var formattedAddress = response.data.results[0].formatted_address;
                var formattedAddressOutput = `
                    <ul class = "list-group">
                        <li class = "list-group-item"><strong>Address</strong>: ${formattedAddress}</li>
                        </ul>
                `;

                //address components
                var addressComponents = response.data.results[0].address_components;
                var addressComponentsOutput = '<ul class = "list-group">';

                addressComponentsOutput += "</ul>"

                //geometry
                //formatted address
                var lat = response.data.results[0].geometry.location.lat.toFixed(4);
                var lng = response.data.results[0].geometry.location.lng.toFixed(4);
                var geometryOutput = `
                    <ul class = "list-group">
                        <li class = "list-group-item"><strong>Coordinates</strong>: (${lat}, ${lng}) </li>
                        </ul>
                `;
            })
            .catch(function(error){
                console.log(error);
            })
        }

        function reverseGeocode() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getCurrentAddress);
                navigator.geolocation.getCurrentPosition(getCurrentGeometry);
            }
        }

        function getCurrentAddress(position) {
            axios.get(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${position.coords.latitude},${position.coords.longitude}&location_type=ROOFTOP&result_type=street_address&key=AIzaSyCsklehWRTLY54gug20dY1zByw0JosG-So`)

            .then(function(response) {directionsStart = response.data.results[0].formatted_address;})

            .catch(function(error) {console.log(error);})
        }

        function getCurrentGeometry(position) {
            axios.get(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${position.coords.latitude},${position.coords.longitude}&location_type=ROOFTOP&result_type=street_address&key=AIzaSyCsklehWRTLY54gug20dY1zByw0JosG-So`)

            .then(function(response) {currentGeometry = response.data.results[0].geometry.location;})

            .catch(function(error) {console.log(error);})
        }

        var autocomplete;
            function initAutocomplete() {
            center = {lat: 33.7971, lng: -84.3222};
            defaultBounds = {
                north: center.lat + 0.05,
                south: center.lat -0.05,
                east: center.lng + 0.05,
                west: center.lng - 0.05,
            };
            autocomplete = new google.maps.places.Autocomplete(
                document.getElementById('location-input'),
                {
                    types: [],
                    componentRestrictions: {'country': ['US']}, //improves predictions
                    fields: ['place_id', 'geometry', 'name', 'formatted_phone_number', 'icon', 'photos', 'website', 'formatted_address'],
                    strictBounds: false,
                    bounds: defaultBounds,
                });

            autocomplete.addListener('place_changed', onPlaceChanged);

            function onPlaceChanged() {
                if (markerArray.length != 0) {clearDirections();}
                
                place = autocomplete.getPlace();
                photoNum = 0;

                findAllDistances(place.name);

                if(!place.geometry) {
                    //did not select a prediction
                    document.getElementById('location-input').placeholder = 'Search';
                } else {
                    let text = '';
                    //display info about valid place
                    if (place.name) {
                        text += `<h4>${place.name}</h4><br>`;
                    }
                    if (place.formatted_address) {
                        text += `${place.formatted_address}<br><br>`;
                    }
                    text += `${place.geometry.location.lat().toFixed(4)}, ${place.geometry.location.lng().toFixed(4)}<br><br>`;
                    if (place.formatted_phone_number) {
                        text += `${place.formatted_phone_number}<br><br>`;
                    }
                    if (place.website) {
                        text += `<a href = ${place.website}>Website</a><br>`;
                    }

                document.getElementById('place-name').innerHTML = `
                    <ul class = "list-group">
                        <li class = "list-group-item">${text}</li>
                        </ul>
                `;

                if (place.photos) {
                    var firstPhoto = place.photos[0].getUrl();
                    document.getElementById(`place-photos`).src = `${firstPhoto}`;
                    if (place.photos.length > 1) {
                        document.getElementById('left-img').hidden = false;
                        document.getElementById('right-img').hidden = false;
                    }
                }
                else {
                    document.getElementById(`place-photos`).src = `https://upload.wikimedia.org/wikipedia/commons/1/11/Greg_Fenves_13879_003.jpg`; 
                    document.getElementById('left-img').hidden = true;
                    document.getElementById('right-img').hidden = true;
                }

                document.getElementById('sidebar').hidden = false;
                document.getElementById('directions-button').hidden = false;

                var newMarker = {
                    coords:place.geometry.location,
                    content: `${place.name}`
                }   
        
                addMarker(newMarker, );
                map.setCenter( {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng()
                });
                }
            }
        }

    function setMapOnAll(map, array) {
        for (let i = 0; i < array.length; i++) {
        array[i].setMap(map);
        }
    }

    // Removes the markers from the map, but keeps them in the array.
    function hideMarkers(array) {
        setMapOnAll(null, array);
    }

    // Shows any markers currently in the array.
    function showMarkers(array) {
        setMapOnAll(map, array);
    }

    // Deletes all markers in the array by removing references to them.
    function deleteMarkers(array) {
        hideMarkers(array);
        if (array == markers) {
            markers = [];
        }
        else if (array == markerArray) {
            markerArray = [];
        }
    }

    function calculateAndDisplayRoute(
        directionsRenderer, directionsService, markerArray, stepDisplay, map, mode) 
    {
        // First, clear out any existing markerArray
        // from previous calculations.
        for (i = 0; i < markerArray.length; i++) {
            markerArray[i].setMap(null);
        }

        // Retrieve the start and end locations and create
        // a DirectionsRequest using WALKING directions.
        reverseGeocode();
        var end = document.getElementById('location-input').value;
        var compared = compareDistances(distances);
        if (compared == null) {
            directionsEnd = end;
        } else {
            directionsEnd = compared;
        }

        var request = {
            origin: directionsStart,
            destination: directionsEnd,
            travelMode: mode,
            provideRouteAlternatives: true
        };

        // Route the directions and pass the response to a
        // function to create markers for each step.
        directionsService.route(request, function(response, status) {
            if (status == "OK") {
                let elevator = new google.maps.ElevationService();
                //var warnings = document.getElementById("warnings_panel");
                //warnings.innerHTML = "" + response.routes[0].warnings + "";
                directionsRenderer.setDirections(response);
                showSteps(response);
                elevations = [];
                for (var i = 0; i < response.routes.length; i++) {
                    elevations.push(0);
                    findElevations(response, elevator, i);
                }
            }
        });
    }

    function showSteps(directionResult) {
        // For each step, place a marker, and add the text to the marker's
        // info window. Also attach the marker to an array so we
        // can keep track of it and remove it when calculating new
        // routes.
         var myRoute = directionResult.routes[0].legs[0]; //here


        for (var i = 0; i < myRoute.steps.length; i++) {
            var marker = new google.maps.Marker({
            position: myRoute.steps[i].start_point, //add elevation
            map: map,
            visible: false
        });

        attachInstructionText(marker, myRoute.steps[i].instructions);
        markerArray[i] = marker;
        }
    }

    function attachInstructionText(marker, text) {
        google.maps.event.addListener(marker, 'click', function() {
        stepDisplay.setContent(text);
        stepDisplay.open(map, marker);
        });
    }

    document.getElementById('directions-button').addEventListener('click', function () { //why is sidebar hidden??
        directionsService = new google.maps.DirectionsService();
            var rendererOptions = {
                map: map
            }
        directionsRenderer = new google.maps.DirectionsRenderer(rendererOptions);
        directionsRenderer.setPanel(document.getElementById("directions-sidebar"));
        calculateAndDisplayRoute(directionsRenderer, directionsService, markerArray, stepDisplay, map, 'WALKING');
        document.getElementById('directions-sidebar').hidden = false;
        document.getElementById('sidebar').hidden = true;
        deleteMarkers(markers);
    });

    function setTransport(mode) {
        calculateAndDisplayRoute(directionsRenderer, directionsService, markerArray, stepDisplay, map, mode);
    }

    function applyFilter(filter) {
        getData().then(function(filterPlaces){
            console.log(filterPlaces);
            deleteMarkers(markers);
            for (let i = 0; i < filterPlaces.length; i++) {
                let types = filterPlaces[i].tags;
                let j = 0;
                while (j < types.length && filter != types[j]) {
                    j++;
                }
                if (j < types.length) {
                    if (filter == 'food' || filter == 'coffee' || filter == 'meal-swipes' || filter == 'vegan' || filter == 'vegetarian') {
                        addMarker({
                            coords: filterPlaces[i].coords,
                            content: `<b><font size='4'>${filterPlaces[i].name}</font></b><br> <a href = ${filterPlaces[i].link}>Menu</a><br> <b>Hours</b><br> ${filterPlaces[i].hours}`
                        }, 'https://maps.google.com/mapfiles/ms/micons/orange-dot.png'); 
                    }
                    else if (filter == 'study' || filter == 'library' || filter == 'printer' || filter == 'private-study' || filter == 'whiteboard') {
                        addMarker({
                            coords: filterPlaces[i].coords,
                            content: `<b><font size='4'>${filterPlaces[i].name}</font></b><br> <a href = ${filterPlaces[i].link}>Menu</a><br> <b>Hours</b><br> ${filterPlaces[i].hours}`
                        }, 'https://maps.google.com/mapfiles/ms/micons/purple-dot.png'); 
                    }
                    else if (filter == 'building' || filter == 'academic' || filter == 'id' || filter == 'dorm') {
                        addMarker({
                            coords: filterPlaces[i].coords,
                            content: `<b><font size='4'>${filterPlaces[i].name}</font></b><br> <a href = ${filterPlaces[i].link}>Menu</a><br> <b>Hours</b><br> ${filterPlaces[i].hours}`
                        }, 'https://maps.google.com/mapfiles/ms/micons/blue-dot.png'); 
                    }
                }
            }
    })
        
    }

    function applyEventsFilter() { //still need to account if multiple clubs involved
        deleteMarkers(markers);
        for (let i = 0; i < filterHub.length; i++) {
            addMarker({
                coords: filterHub[i].coords,
                content: `<b><font size='4'>${filterHub[i].name}</font></b><br> <b>Who</b><br> ${filterHub[i].types[0]}<br> <b>When</b><br> ${filterHub[i].hours}<br> <b>Where</b><br> ${filterHub[i].place}<br><a href = ${filterHub[i].link}>View on The Hub</a><br>`
            }, 'https://maps.google.com/mapfiles/ms/micons/green-dot.png'); 
        }
    }

    function calculateDistance(start, end) {
        let request = {
            origin: start,
            destination: end,
            travelMode: 'WALKING' //here it is
        };

        directionsService.route(request, function(response, status) { //directions only exists inside here
            if (status == "OK") {
            //var warnings = document.getElementById("warnings_panel");
            //warnings.innerHTML = "" + response.routes[0].warnings + "";
                distances.push(new Array(2));
                distances[distances.length-1][0] = end;
                distances[distances.length-1][1] = response.routes[0].legs[0].distance.value;
                //distances.push[end, response.routes[0].legs[0].distance.value];
            }
        });
    }

    function findAllDistances(value) { //still a work in progress but testing
        distances = [];
        let i = 0;
        while (i < practiceRoute.length && practiceRoute[i].name != value) {
            i++;
        }
        if (i < practiceRoute.length) {
            for (j = 0; j < practiceRoute[i].coords.length; j++) {
                calculateDistance(currentGeometry, practiceRoute[i].coords[j]);
            }
        }
        else {
            directionsEnd = '';
        }
    }

    /*
    function calculateDistance(start, end) { //gotta finish this for sure... haversine formula
        let lat1 = start.lat; //may need to be changed if the format is incorrect
        let lat2 = end.lat;
        let lon1 = start.lng;
        let lon2 = end.lng;

        const R = 6371e3; // metres
        const φ1 = lat1 * Math.PI/180; // φ, λ in radians
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lon2-lon1) * Math.PI/180;

        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
x
        const d = R * c; // in metres
        return d;
    }
    */

    //returns index/entrance of the shortest distance

    function compareDistances(value) {
        if (value.length == 0) return null;
        let shortest = 0;
        for (i = 1; i < value.length; i++) {
            if (value[i][1] < value[shortest][1]) {
                shortest = i;
            }
        }
        return value[shortest][0];
    }

    function nextImage(place, direction) {
        if(place.photos && place.photos.length > 1) {
            if (direction == 'right-img') {
                if (photoNum < place.photos.length - 1) {
                    photoNum++;
                }
                else {
                    photoNum = 0;
                }
            }

            if (direction == 'left-img') {
                if (photoNum > 0) {
                    photoNum--;
                }
                else {
                    photoNum = place.photos.length - 1;
                }
            }
            let newPhoto = place.photos[photoNum].getUrl();

            document.getElementById(`place-photos`).src = `${newPhoto}`;
        }
    }

    function findElevations(directionResult, elevator, index) {
  // Initiate the location request
        //for (var i = 0; i < directionResult.routes.length; i++) {
            for (var j = 0; j < directionResult.routes[index].legs[0].steps.length; j++) {
                elevator.getElevationForLocations({
                    locations: [directionResult.routes[index].legs[0].steps[j].end_point]
                })
                .then(({ results }) => {
                    if (results[0].elevation > elevations[index]) {elevations[index] += results[0].elevation - elevations[index];}
                })
                .catch((e) =>
                infowindow.setContent("Elevation service failed due to: " + e));
            }
        //}
    }
    
    </script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCsklehWRTLY54gug20dY1zByw0JosG-So&callback=initialize&v=weekly&libraries=places"
      async defer
      ></script>
</body>
</html>